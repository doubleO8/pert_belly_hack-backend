

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>controllers.utilities &mdash; pert_belly_hack_backend 1.3.0+5.g2f249f9 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pert_belly_hack_backend
          

          
          </a>

          
            
            
              <div class="version">
                1.3.0+5.g2f249f9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugin.html">Plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web_controller.html">Web Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../e2webinterface_api.html">Enigma2 WebInterface API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../restful_api.html">RESTful API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controller.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packaging.html">Packaging and Publication</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pert_belly_hack_backend</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>controllers.utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for controllers.utilities</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">wsgiref.handlers</span> <span class="k">import</span> <span class="n">format_date_time</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>

<span class="n">CONTRIB</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../../contrib&#39;</span><span class="p">)</span>

<span class="n">MANY_SLASHES_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[\/]+&#39;</span>
<span class="n">MANY_SLASHES_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">MANY_SLASHES_PATTERN</span><span class="p">)</span>

<span class="n">PATTERN_ITEM_OR_KEY_ACCESS</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(?P&lt;attr_name&gt;[a-zA-Z][\w\d]*)&#39;</span> \
                             <span class="sa">r</span><span class="s1">&#39;\[((?P&lt;index&gt;\d+)|&#39;</span> \
                             <span class="sa">r</span><span class="s1">&#39;[</span><span class="se">\&#39;</span><span class="s1">\&quot;](?P&lt;key&gt;[\s\w\d]+)[</span><span class="se">\&#39;</span><span class="s1">\&quot;])\]$&#39;</span>
<span class="n">REGEX_ITEM_OR_KEY_ACCESS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">PATTERN_ITEM_OR_KEY_ACCESS</span><span class="p">)</span>

<span class="n">SERVICEREFERENCE_PORTION_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;([\da-fA-F]+)[^\w]?&#39;</span>
<span class="n">SERVICEREFERENCE_PORTION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">SERVICEREFERENCE_PORTION_PATTERN</span><span class="p">)</span>

<span class="c1">#: regular expression pattern for strings containing something resembling</span>
<span class="c1">#: a hostname/port combination (``&lt;hostname&gt;:&lt;port&gt;``)</span>
<span class="n">PATTERN_HOST_HEADER</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(\[(?P&lt;ipv6_addr&gt;.+?)\]|(?P&lt;hostname&gt;.+?))&#39;</span> \
                      <span class="sa">r</span><span class="s1">&#39;(\:(?P&lt;port&gt;\d+))?$&#39;</span>
<span class="n">REGEX_HOST_HEADER</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">PATTERN_HOST_HEADER</span><span class="p">)</span>

<span class="c1"># stolen from enigma2_http_api ...</span>
<span class="c1"># https://wiki.neutrino-hd.de/wiki/Enigma:Services:Formatbeschreibung</span>
<span class="c1"># Dezimalwert: 1=TV, 2=Radio, 4=NVod, andere=Daten</span>

<span class="n">SERVICE_TYPE_TV</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="n">SERVICE_TYPE_RADIO</span> <span class="o">=</span> <span class="mh">0x02</span>
<span class="n">SERVICE_TYPE_SD4</span> <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">SERVICE_TYPE_HDTV</span> <span class="o">=</span> <span class="mh">0x19</span>
<span class="n">SERVICE_TYPE_UHD</span> <span class="o">=</span> <span class="mh">0x1f</span>
<span class="n">SERVICE_TYPE_OPT</span> <span class="o">=</span> <span class="mh">0xd3</span>

<span class="n">SERVICE_KIND_COMMENT</span> <span class="o">=</span> <span class="mh">0x64</span>

<span class="c1"># type 1 = digital television service</span>
<span class="c1"># type 2 = digital radio sound service</span>
<span class="c1"># type 4 = nvod reference service (NYI)</span>
<span class="c1"># type 10 = advanced codec digital radio sound service</span>
<span class="c1"># type 17 = MPEG-2 HD digital television service</span>
<span class="c1"># type 22 = advanced codec SD digital television</span>
<span class="c1"># type 24 = advanced codec SD NVOD reference service (NYI)</span>
<span class="c1"># type 25 = advanced codec HD digital television</span>
<span class="c1"># type 27 = advanced codec HD NVOD reference service (NYI)</span>


<span class="n">SERVICE_TYPE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;TV&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_TV</span><span class="p">,</span>
    <span class="s1">&#39;HDTV&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_HDTV</span><span class="p">,</span>
    <span class="s1">&#39;RADIO&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_RADIO</span><span class="p">,</span>
    <span class="s1">&#39;UHD&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_UHD</span><span class="p">,</span>
    <span class="s1">&#39;SD4&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_SD4</span><span class="p">,</span>
    <span class="s1">&#39;OPT&#39;</span><span class="p">:</span> <span class="n">SERVICE_TYPE_OPT</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SERVICE_TYPE_LOOKUP</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">SERVICE_TYPE</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>

<span class="c1">#: Namespace - DVB-C services</span>
<span class="n">NS_DVB_C</span> <span class="o">=</span> <span class="mh">0xffff0000</span>

<span class="c1">#: Namespace - DVB-S services</span>
<span class="n">NS_DVB_S</span> <span class="o">=</span> <span class="mh">0x00c00000</span>

<span class="c1">#: Namespace - DVB-T services</span>
<span class="n">NS_DVB_T</span> <span class="o">=</span> <span class="mh">0xeeee0000</span>

<span class="c1">#: Label:Namespace map</span>
<span class="n">NS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DVB-C&#39;</span><span class="p">:</span> <span class="n">NS_DVB_C</span><span class="p">,</span>
    <span class="s1">&#39;DVB-S&#39;</span><span class="p">:</span> <span class="n">NS_DVB_S</span><span class="p">,</span>
    <span class="s1">&#39;DVB-T&#39;</span><span class="p">:</span> <span class="n">NS_DVB_T</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">#: Namespace:Label lookup map</span>
<span class="n">NS_LOOKUP</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">NS</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>

<span class="n">CUTS_IN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">CUTS_OUT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">CUTS_MARK</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">CUTS_WATCHMARK</span> <span class="o">=</span> <span class="mi">3</span>


<div class="viewcode-block" id="lenient_decode"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.lenient_decode">[docs]</a><span class="k">def</span> <span class="nf">lenient_decode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode an encoded string and convert it to an unicode string.</span>

<span class="sd">    Args:</span>
<span class="sd">            value: input value</span>
<span class="sd">            encoding: string encoding, defaults to utf-8</span>
<span class="sd">    Returns:</span>
<span class="sd">            :obj:`unicode`: decoded value</span>

<span class="sd">    &gt;&gt;&gt; lenient_decode(&quot;Hallo&quot;)</span>
<span class="sd">    u&#39;Hallo&#39;</span>
<span class="sd">    &gt;&gt;&gt; lenient_decode(u&quot;Hallo&quot;)</span>
<span class="sd">    u&#39;Hallo&#39;</span>
<span class="sd">    &gt;&gt;&gt; lenient_decode(&quot;HällöÜ&quot;)</span>
<span class="sd">    u&#39;H\\xe4ll\\xf6\\xdc&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;utf_8&#39;</span>

    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="lenient_force_utf_8"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.lenient_force_utf_8">[docs]</a><span class="k">def</span> <span class="nf">lenient_force_utf_8</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">            value: input value</span>
<span class="sd">    Returns:</span>
<span class="sd">            :obj:`basestring` utf-8 encoded value</span>

<span class="sd">    &gt;&gt;&gt; isinstance(lenient_force_utf_8(&#39;&#39;), basestring)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; lenient_force_utf_8(u&quot;Hallo&quot;)</span>
<span class="sd">    &#39;Hallo&#39;</span>
<span class="sd">    &gt;&gt;&gt; lenient_force_utf_8(&quot;HällöÜ&quot;)</span>
<span class="sd">    &#39;H\\xc3\\xa4ll\\xc3\\xb6\\xc3\\x9c&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lenient_decode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf_8&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="sanitise_filename_slashes"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.sanitise_filename_slashes">[docs]</a><span class="k">def</span> <span class="nf">sanitise_filename_slashes</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">            value(basestring): input value</span>
<span class="sd">    Returns:</span>
<span class="sd">            value w/o multiple slashes</span>

<span class="sd">    &gt;&gt;&gt; in_value = &quot;///tmp/x/y/z&quot;</span>
<span class="sd">    &gt;&gt;&gt; expected = re.sub(&quot;^/+&quot;, &quot;/&quot;, &quot;///tmp/x/y/z&quot;)</span>
<span class="sd">    &gt;&gt;&gt; sanitise_filename_slashes(in_value) == expected</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">MANY_SLASHES_REGEX</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_config_attribute"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.get_config_attribute">[docs]</a><span class="k">def</span> <span class="nf">get_config_attribute</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">root_obj</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine attribute of *root_obj* to be accessed by *path* in a</span>
<span class="sd">    (somewhat) safe manner.</span>
<span class="sd">    This implementation will allow key and index based accessing too</span>
<span class="sd">    (e.g. ``config.some_list[0]`` or ``config.some_dict[&#39;some_key&#39;]``)</span>
<span class="sd">    The *path* value needs to start with *head* (default=&#39;config&#39;).</span>

<span class="sd">    Args:</span>
<span class="sd">        path: character string specifying which attribute is to be accessed</span>
<span class="sd">        root_obj: An object whose attributes are to be accessed.</span>
<span class="sd">        head: Value of the first portion of *path*</span>

<span class="sd">    Returns:</span>
<span class="sd">        Attribute of *root_obj*</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If *path* is invalid.</span>
<span class="sd">        AttributeError: If attribute cannot be accessed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">head</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s1">&#39;config&#39;</span>
    <span class="n">portions</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">portions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid path length&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">portions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">head</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Head is </span><span class="si">{!r}</span><span class="s1">, expected </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">portions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">head</span><span class="p">))</span>

    <span class="n">current_obj</span> <span class="o">=</span> <span class="n">root_obj</span>

    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">portions</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty attr_name&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;private member&#39;</span><span class="p">)</span>

        <span class="n">matcher</span> <span class="o">=</span> <span class="n">REGEX_ITEM_OR_KEY_ACCESS</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matcher</span><span class="p">:</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">gdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr_name&#39;</span><span class="p">)</span>
            <span class="n">next_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
                <span class="n">current_obj</span> <span class="o">=</span> <span class="n">next_obj</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                <span class="n">current_obj</span> <span class="o">=</span> <span class="n">next_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">current_obj</span></div>


<div class="viewcode-block" id="parse_servicereference"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.parse_servicereference">[docs]</a><span class="k">def</span> <span class="nf">parse_servicereference</span><span class="p">(</span><span class="n">serviceref</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a Enigma2 style service reference string representation.</span>

<span class="sd">    Args:</span>
<span class="sd">        serviceref: Enigma2 style service reference</span>
<span class="sd">        separators: Allowed separators</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict containing parsed values</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If *serviceref* is invalid.</span>

<span class="sd">    &gt;&gt;&gt; sref = &#39;1:0:1:300:7:85:00c00000:0:0:0:&#39;</span>
<span class="sd">    &gt;&gt;&gt; result = parse_servicereference(sref)</span>
<span class="sd">    &gt;&gt;&gt; result</span>
<span class="sd">    {&#39;service_type&#39;: 1, &#39;oid&#39;: 133, &#39;tsid&#39;: 7, &#39;ns&#39;: 12582912, &#39;sid&#39;: 768}</span>
<span class="sd">    &gt;&gt;&gt; sref_dashes = &#39;1-0-1-300-7-85-00c00000-0-0-0-&#39;</span>
<span class="sd">    &gt;&gt;&gt; result_dashes = parse_servicereference(sref_dashes, &#39;:-&#39;)</span>
<span class="sd">    &gt;&gt;&gt; result == result_dashes</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; sref_g = create_servicereference(**result)</span>
<span class="sd">    &gt;&gt;&gt; sref_g</span>
<span class="sd">    &#39;1:0:1:300:7:85:00c00000:0:0:0:&#39;</span>
<span class="sd">    &gt;&gt;&gt; sref_g2 = create_servicereference(result)</span>
<span class="sd">    &gt;&gt;&gt; sref_g2</span>
<span class="sd">    &#39;1:0:1:300:7:85:00c00000:0:0:0:&#39;</span>
<span class="sd">    &gt;&gt;&gt; sref == sref_g</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; sref2 = &#39;1:64:A:0:0:0:0:0:0:0::SKY Sport&#39;</span>
<span class="sd">    &gt;&gt;&gt; result2 = parse_servicereference(sref2)</span>
<span class="sd">    &gt;&gt;&gt; result2</span>
<span class="sd">    {&#39;service_type&#39;: 10, &#39;oid&#39;: 0, &#39;tsid&#39;: 0, &#39;ns&#39;: 0, &#39;sid&#39;: 0}</span>
<span class="sd">    &gt;&gt;&gt; result2e = parse_servicereference(sref2, extended=True)</span>
<span class="sd">    &gt;&gt;&gt; result2e[&#39;kind&#39;]</span>
<span class="sd">    100</span>
<span class="sd">    &gt;&gt;&gt; sref3 = &#39;1:0:0:0:0:0:0:0:0:0:/media/hdd/movie/20170921 2055 - DASDING - DASDING Sprechstunde - .ts&#39;  # NOQA</span>
<span class="sd">    &gt;&gt;&gt; result3 = parse_servicereference(sref3)</span>
<span class="sd">    &gt;&gt;&gt; result3</span>
<span class="sd">    {&#39;service_type&#39;: 0, &#39;oid&#39;: 0, &#39;tsid&#39;: 0, &#39;ns&#39;: 0, &#39;sid&#39;: 0}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">separators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">separators</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">separators</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">separator</span> <span class="ow">in</span> <span class="n">separators</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">serviceref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sref_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;service_type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="s1">&#39;tsid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="s1">&#39;oid&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">extended</span><span class="p">:</span>
                <span class="n">sref_data</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sref_data</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">separators</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_servicereference"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.create_servicereference">[docs]</a><span class="k">def</span> <span class="nf">create_servicereference</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a (Enigma2 style) service reference string representation.</span>

<span class="sd">    :param args[0]: Service Reference Parameter as dict</span>
<span class="sd">    :type args[0]: :class:`dict`</span>

<span class="sd">    :param service_type: Service Type</span>
<span class="sd">    :type service_type: int</span>

<span class="sd">    :param sid: SID</span>
<span class="sd">    :type sid: int</span>

<span class="sd">    :param tsid: TSID</span>
<span class="sd">    :type tsid: int</span>

<span class="sd">    :param oid: OID</span>
<span class="sd">    :type oid: int</span>

<span class="sd">    :param ns: Enigma2 Namespace</span>
<span class="sd">    :type ns: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">service_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;service_type&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">tsid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tsid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">oid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:x}</span><span class="s1">:0:</span><span class="si">{:x}</span><span class="s1">:</span><span class="si">{:x}</span><span class="s1">:</span><span class="si">{:x}</span><span class="s1">:</span><span class="si">{:x}</span><span class="s1">:</span><span class="si">{:08x}</span><span class="s1">:0:0:0:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">service_type</span><span class="p">,</span>
        <span class="n">sid</span><span class="p">,</span>
        <span class="n">tsid</span><span class="p">,</span>
        <span class="n">oid</span><span class="p">,</span>
        <span class="n">ns</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_servicereference_portions"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.get_servicereference_portions">[docs]</a><span class="k">def</span> <span class="nf">get_servicereference_portions</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">raise_on_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to match possible portions of a servicereference in *value*.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (basestring): a servicereference-like string</span>
<span class="sd">        raise_on_empty (boolean): If a ValueError should be raised</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: matched portions</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If result is empty list and *raise_on_empty* is True</span>

<span class="sd">    &gt;&gt;&gt; deadbeef = [&#39;de&#39;, &#39;ad&#39;, &#39;be&#39;, &#39;ef&#39;]</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(None)</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(True)</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(False)</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(&#39;de:ad:be:ef&#39;) == deadbeef</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(&#39;de,ad$be_ef??&#39;) == deadbeef</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(&#39;-1:ad:be:ef:&#39;)</span>
<span class="sd">    [&#39;1&#39;, &#39;ad&#39;, &#39;be&#39;, &#39;ef&#39;]</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(&#39;-^ghi&#39;, raise_on_empty=True)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError: -^ghi</span>
<span class="sd">    &gt;&gt;&gt; get_servicereference_portions(&#39;1:0:19:7C:6:85:FFFF0000:0:0:0:&#39;)</span>
<span class="sd">    [&#39;1&#39;, &#39;0&#39;, &#39;19&#39;, &#39;7C&#39;, &#39;6&#39;, &#39;85&#39;, &#39;FFFF0000&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">SERVICEREFERENCE_PORTION_REGEX</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span> <span class="ow">and</span> <span class="n">raise_on_empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span></div>


<div class="viewcode-block" id="mangle_snp"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.mangle_snp">[docs]</a><span class="k">def</span> <span class="nf">mangle_snp</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mangle service_name as suggested by SNP (Service Name Picons)</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        * https://github.com/picons/picons-source</span>
<span class="sd">        * https://github.com/OpenViX/enigma2/blob/master/lib/python/Components/Renderer/Picon.py#L88-L89</span>

<span class="sd">    Args:</span>
<span class="sd">        value (basestring): service name</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: normalised service name</span>

<span class="sd">    &gt;&gt;&gt; mangle_snp(&#39;?ANTENNE? BAYERN&#39;)</span>
<span class="sd">    &#39;antennebayern&#39;</span>
<span class="sd">    &gt;&gt;&gt; mangle_snp(&#39;?Sky? ?Cine?ma +?24?&#39;)</span>
<span class="sd">    &#39;skycinemaplus24&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unicode_value</span> <span class="o">=</span> <span class="n">lenient_decode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;utf_8&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">unicode_value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">normalised</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;plus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;star&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-z0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">normalised</span><span class="p">)</span></div>


<div class="viewcode-block" id="require_valid_file_parameter"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.require_valid_file_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_valid_file_parameter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">parameter_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        request (twisted.web.server.Request): HTTP request object</span>
<span class="sd">        parameter_key: filename parameter key</span>

<span class="sd">    Returns:</span>
<span class="sd">        basestring: existing filename</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If *parameter_key* is missing.</span>
<span class="sd">        IOError: If filename does not point to an existing file path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parameter_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing parameter: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter_key</span><span class="p">))</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">lenient_force_utf_8</span><span class="p">(</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">unquote_plus</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">parameter_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">sanitise_filename_slashes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Not a file: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="build_url"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.build_url">[docs]</a><span class="k">def</span> <span class="nf">build_url</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an URL based on parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        hostname: hostname portion</span>
<span class="sd">        path: path portion</span>
<span class="sd">        args: query parameters</span>
<span class="sd">        scheme: scheme portion</span>
<span class="sd">        port: port portion</span>

<span class="sd">    Returns:</span>
<span class="sd">        basestring: Generated URL</span>

<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;/&quot;, {})</span>
<span class="sd">    &#39;http://some.host/&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;/&quot;)</span>
<span class="sd">    &#39;http://some.host/&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;)</span>
<span class="sd">    &#39;http://some.host&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, port=27080)</span>
<span class="sd">    &#39;http://some.host:27080&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;&quot;, port=27080)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError: empty hostname!</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;x&quot;)</span>
<span class="sd">    &#39;http://some.host/x&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;/x&quot;)</span>
<span class="sd">    &#39;http://some.host/x&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;/x/&quot;)</span>
<span class="sd">    &#39;http://some.host/x/&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;x/&quot;)</span>
<span class="sd">    &#39;http://some.host/x/&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;x/../&quot;)</span>
<span class="sd">    &#39;http://some.host/x/../&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, &quot;/:x/äöü-blabla/&quot;)</span>
<span class="sd">    &#39;http://some.host/%3Ax/%C3%A4%C3%B6%C3%BC-blabla/&#39;</span>
<span class="sd">    &gt;&gt;&gt; build_url(&quot;some.host&quot;, u&#39;/:x/\xe4\xf6\xfc-blabla/&#39;.encode(&#39;utf-8&#39;))</span>
<span class="sd">    &#39;http://some.host/%3Ax/%C3%A4%C3%B6%C3%BC-blabla/&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hostname</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty hostname!&quot;</span><span class="p">)</span>

    <span class="n">netloc</span> <span class="o">=</span> <span class="n">hostname</span>
    <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">:</span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path_q</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_q</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">args_e</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_e</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path_q</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args_e</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>


<div class="viewcode-block" id="mangle_host_header_port"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.mangle_host_header_port">[docs]</a><span class="k">def</span> <span class="nf">mangle_host_header_port</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">fallback_port</span><span class="o">=</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="n">fallback_hostname</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                            <span class="n">want_url</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        value: header data</span>
<span class="sd">        fallback_port: fallback value for port (default ``80``)</span>
<span class="sd">        fallback_hostname: fallback value for hostname (default ``localhost``)</span>
<span class="sd">        want_url: return an URL string</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Mangled *port, proto* values</span>

<span class="sd">    &gt;&gt;&gt; resi1 = mangle_host_header_port()</span>
<span class="sd">    &gt;&gt;&gt; resi1[&#39;netloc&#39;]</span>
<span class="sd">    &#39;localhost&#39;</span>
<span class="sd">    &gt;&gt;&gt; resi2 = mangle_host_header_port(&quot;localhost:80&quot;)</span>
<span class="sd">    &gt;&gt;&gt; resi2[&#39;netloc&#39;]</span>
<span class="sd">    &#39;localhost&#39;</span>
<span class="sd">    &gt;&gt;&gt; resi3 = mangle_host_header_port(&quot;x:123&quot;)</span>
<span class="sd">    &gt;&gt;&gt; resi3[&#39;netloc&#39;]</span>
<span class="sd">    &#39;x:123&#39;</span>
<span class="sd">    &gt;&gt;&gt; resi4 = mangle_host_header_port(&quot;haha:342111&quot;)</span>
<span class="sd">    &gt;&gt;&gt; resi4[&#39;netloc&#39;]</span>
<span class="sd">    &#39;haha&#39;</span>
<span class="sd">    &gt;&gt;&gt; resi5 = mangle_host_header_port(&quot;haha:342111&quot;, want_url=True)</span>
<span class="sd">    &gt;&gt;&gt; resi5</span>
<span class="sd">    &#39;http://haha&#39;</span>
<span class="sd">    &gt;&gt;&gt; resi6 = mangle_host_header_port(&quot;localhost:12345&quot;, want_url=True)</span>
<span class="sd">    &gt;&gt;&gt; resi6</span>
<span class="sd">    &#39;http://localhost:12345&#39;</span>
<span class="sd">    &gt;&gt;&gt; mangle_host_header_port(&quot;[2001:0db8:85a3:08d3::0370:7344]&quot;, want_url=True)  # NOQA</span>
<span class="sd">    &#39;http://[2001:0db8:85a3:08d3::0370:7344]&#39;</span>
<span class="sd">    &gt;&gt;&gt; mangle_host_header_port(&quot;[2001:0db8:85a3:08d3::0370:7344]&quot;)[&#39;netloc&#39;]</span>
<span class="sd">    &#39;[2001:0db8:85a3:08d3::0370:7344]&#39;</span>
<span class="sd">    &gt;&gt;&gt; mangle_host_header_port(&quot;[2001:0db8:85a3:08d3::0370:7344]:8080/&quot;, want_url=True)  # NOQA</span>
<span class="sd">    &#39;http://[2001:0db8:85a3:08d3::0370:7344]:8080/&#39;</span>
<span class="sd">    &gt;&gt;&gt; mangle_host_header_port(&quot;[2001:0db8:85a3:08d3::0370:7344]:8080&quot;)[&#39;netloc&#39;]  # NOQA</span>
<span class="sd">    &#39;[2001:0db8:85a3:08d3::0370:7344]:8080&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">proto</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span>  <span class="c1"># deprecated, added just for compatibility</span>
        <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">fallback_port</span><span class="p">,</span>
        <span class="n">hostname</span><span class="o">=</span><span class="n">fallback_hostname</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">REGEX_HOST_HEADER</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matcher</span><span class="p">:</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ipv6_addr&quot;</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">{ipv6_addr}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">gdict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdict</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">port_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">port_i</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_port</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;netloc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{hostname}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;netloc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">want_url</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">):</span>
            <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">build_url</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">],</span>
                         <span class="n">scheme</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">],</span>
                         <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="k">def</span> <span class="nf">parse_cuts</span><span class="p">(</span><span class="n">cutfile</span><span class="p">):</span>
    <span class="n">marks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;watched&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;marks&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cutfile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pts_value</span><span class="p">,</span> <span class="n">cue_kind</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;QI&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">pts_value</span> <span class="o">/</span> <span class="mi">90000</span>
            <span class="k">if</span> <span class="n">cue_kind</span> <span class="o">==</span> <span class="n">CUTS_WATCHMARK</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;watched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seconds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seconds</span><span class="p">,</span> <span class="n">cue_kind</span><span class="p">])</span>

            <span class="n">chunk</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">]:</span>
            <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;maximum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">marks</span>


<div class="viewcode-block" id="add_expires_header"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.add_expires_header">[docs]</a><span class="k">def</span> <span class="nf">add_expires_header</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        request (twisted.web.server.Request): HTTP request object</span>
<span class="sd">        expires: expiration in seconds or False for *imediately / no caching*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">expires</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span>
            <span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no-store, no-cache, must-revalidate, &#39;</span> \
                               <span class="s1">&#39;post-check=0, pre-check=0, max-age=0&#39;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">expires_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_date_time</span><span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">expires_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
        <span class="c1"># self.log.debug(</span>
        <span class="c1">#     &quot;CACHE: {key}={val}&quot;.format(key=key, val=headers[key]))</span>
        <span class="n">request</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div>


<div class="viewcode-block" id="parse_simple_index"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.parse_simple_index">[docs]</a><span class="k">def</span> <span class="nf">parse_simple_index</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &gt;&gt;&gt; snp_index = os.path.join(CONTRIB, &#39;picon-source/snp.index&#39;)</span>
<span class="sd">    &gt;&gt;&gt; snp = parse_simple_index(snp_index)</span>
<span class="sd">    &gt;&gt;&gt; len(snp.keys()) &gt; 1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; snp[&#39;wdrduesseldorf&#39;]</span>
<span class="sd">    &#39;wdr&#39;</span>
<span class="sd">    &gt;&gt;&gt; snp[&#39;wdrdusseldorf&#39;]</span>
<span class="sd">    &#39;wdr&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">lookup</span></div>


<span class="k">def</span> <span class="nf">gen_reverse_proxy_configuration</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                                <span class="s1">&#39;reverse_proxy.conf.template&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">template_content</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">fallback_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;REVERSE_PROXY_PORT&quot;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s2">&quot;ENIGMA2_HOST&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ENIGMA2_PORT&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s2">&quot;OSCAM_PORT&quot;</span><span class="p">:</span> <span class="mi">83</span><span class="p">,</span>
        <span class="s2">&quot;STREAM_PORT&quot;</span><span class="p">:</span> <span class="mi">8001</span><span class="p">,</span>
        <span class="s2">&quot;STREAM_TRANSCODED_PORT&quot;</span><span class="p">:</span> <span class="mi">8002</span><span class="p">,</span>
        <span class="s2">&quot;PUBLIC_ROOT&quot;</span><span class="p">:</span> <span class="s1">&#39;/tmp/public&#39;</span><span class="p">,</span>
        <span class="s2">&quot;PICON_ROOT&quot;</span><span class="p">:</span> <span class="s1">&#39;/tmp/picon&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fallback_values</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fallback_values</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PUBLIC_ROOT&#39;</span><span class="p">,</span> <span class="s1">&#39;PICON_ROOT&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\/+$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">search_key</span> <span class="o">=</span> <span class="s1">&#39;{{</span><span class="si">{:s}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">template_content</span> <span class="o">=</span> <span class="n">template_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">search_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">template_content</span>


<div class="viewcode-block" id="mangle_service_type_arg"><a class="viewcode-back" href="../../utilities.html#controllers.utilities.mangle_service_type_arg">[docs]</a><span class="k">def</span> <span class="nf">mangle_service_type_arg</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate &#39;tv&#39; or &#39;radio&#39; to a set containing the needed service_type IDs.</span>
<span class="sd">    Other values of *item* are expected to be an integer value.</span>

<span class="sd">    Args:</span>
<span class="sd">        item (str or int): service_type value</span>

<span class="sd">    Returns:</span>
<span class="sd">        set: service_type IDs</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If a non-integer value was provided</span>

<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(&quot;tv&quot;) == set([1, 195, 134, 17, 22, 25, 31])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(&quot;radio&quot;) == set([2, 10])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(0x10) == { 16 }</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(1) == {1}</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(&quot;1&quot;) == {1}</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; mangle_service_type_arg(&quot;&quot;) == {1}</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError: invalid literal for int() with base 10: &#39;&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;tv&#39;</span><span class="p">:</span>
            <span class="c1"># service_types_tv = 1:7:1:0:0:0:0:0:0:0:(type == 1) || (type == 17) || (type == 22) || (type == 25) || (type == 31) || (type == 134) || (type == 195)  # NOQA</span>
            <span class="k">return</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">195</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;radio&#39;</span><span class="p">:</span>
            <span class="c1"># service_types_radio = 1:7:2:0:0:0:0:0:0:0:(type == 2) || (type == 10)</span>
            <span class="k">return</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="p">{</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">}</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="p">(</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">SUCCEEDED</span><span class="p">)</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[doctest] SUCCEEDED/FAILED: </span><span class="si">{:d}</span><span class="s2">/</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">,</span> <span class="n">FAILED</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, nobody@localhost

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>